---
title: "Example Workflows"
author: "Mark Edmondson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example Workflows}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

> See all documentation on the [googleComputeEngineR website](https://cloudyr.github.io/googleComputeEngineR/)

Follows are some R scripts for common workflows.  They assume you have previously signed up and setup a Google project and authentication.

## An RStudio Server for your team

```r
library(googleComputeEngineR)

## setting up a 13GB RAM instance 
## see gce_list_machinetype() for options of predefined_type
vm <- gce_vm(template = "rstudio-hadleyverse",
             name = "rstudio-team",
             username = "mark", password = "mark1234",
             predefined_type = "n1-highmem-2")

## wait a bit, login at the IP it gives you

## add users
gce_rstudio_adduser(vm, username = "bill", password = "flowerpot")

## install packages by logging into RStudio and installing via UI
## use the Terminal in RStudio if required to install dependencies
## or use docker_cmd

## see the containers running on the instance
cons <- containers(vm)
cons
## the default template RStudio container is called "rstudio"

## once setup, save the RStudio container to a new image for quick start in another instance
gce_save_container(vm, 
                   container_name = "my_rstudio",
                   image_name = "rstudio")

## stop the VM when not in use to save bills
gce_vm_stop(vm)

## start up another VM with different configuration from your saved docker container

## start a 50GB RAM instance
## containers need to be launched in "google-containers" image_family pre-loaded with docker
vm2 <- gce_vm(name = "rstudio-big",
              predefined_type = "n1-highmem-8",
              image_project = "google-containers",
              image_family = "gci-stable")

## wait for it to launch

## load and run the container, mapping RStudio port of 8787 to 80
gce_load_container(vm2, "my_rstudio", "-p 80:8787")

## make sure to stop this one, it will be more expensive
gce_vm_stop(vm2)

```

## A remote R cluster to run big R programs

```r
library(future)
library(googleComputeEngineR)

## names for your cluster
vm_names <- c("vm1","vm2","vm3")

## create the cluster using the package's default cloud-config template for r-base
## you may want to make your own cloud-config file
## creates jobs that are creating VMs in background
jobs <- lapply(vm_names, function(x) {
    gce_vm_container(file = system.file("cloudconfig", "r-base.yaml",  package = "googleComputeEngineR"),
                     predefined_type = "n1-highmem-2",
                     name = x)
                     })
jobs
# [[1]]
# ==Operation insert :  PENDING
# Started:  2016-11-16 06:52:58
# [[2]]
# ==Operation insert :  PENDING
# Started:  2016-11-16 06:53:04
# [[3]]
# ==Operation insert :  PENDING
# Started:  2016-11-16 06:53:09

## check status of jobs
lapply(jobs, function(x) gce_get_zone_op(x))
# [[1]]
# ==Operation insert :  DONE
# Started:  2016-11-16 06:52:58
# Ended: 2016-11-16 06:53:14 
# Operation complete in 16 secs 

# [[2]]
# ==Operation insert :  DONE
# Started:  2016-11-16 06:53:04
# Ended: 2016-11-16 06:53:20 
# Operation complete in 16 secs 

# [[3]]
# ==Operation insert :  DONE
# Started:  2016-11-16 06:53:09
# Ended: 2016-11-16 06:53:30 
# Operation complete in 21 secs

## get the VM objects
vms <- lapply(vm_names, gce_vm)

## set up SSH for the VMs
vms <- lapply(vms, gce_ssh_setup)

## make a future object
plan(cluster, workers = as.cluster(vms))

## use %<-% to send functions to work on cluster
## See future README for details: https://github.com/HenrikBengtsson/future
a %<-% Sys.getpid()

## make a big function to run asynchronously
f <- function(my_data, args){
   ## ....expensive...computations
   
   result
}

## send to cluster
result %<-% f(my_data) 

## check if resolved
resolved(result)

## shutdown instances when finished
lapply(vms, gce_vm_stop)

```


## An RStudio server to run scheduled scripts upon

This takes advatage of Dockerfiles to customise the templates.  

Build your own Dockerfiles to customise your instances with installed packages etc. 

```r
library(googleComputeEngineR)

## default f1-micro instance
## installs rocker/hadleyverse docker image
vm <- gce_vm(name = "schedule-r", template = "rstudio-hadleyverse")

## This Dockerfile adds cron, nano, googleAuthR and bnosac/cronR from github
readLines(get_dockerfile("hadleyverse-crontab"))
# [1] "FROM rocker/hadleyverse"                                             
# [2] "MAINTAINER Mark Edmondson (r@sunholo.com)"                           
# [3] ""                                                                    
# [4] "# install cron and R package dependencies"                           
# [5] "RUN apt-get update && apt-get install -y \\"                         
# [6] "    cron \\"                                                         
# [7] "    nano \\"                                                         
# [8] "    ## clean up"                                                     
# [9] "    && apt-get clean \\ "                                            
# [10] "    && rm -rf /var/lib/apt/lists/ \\ "                               
# [11] "    && rm -rf /tmp/downloaded_packages/ /tmp/*.rds"                  
# [12] "    "                                                                
# [13] "## Install packages from CRAN"                                       
# [14] "RUN install2.r --error \\ "                                          
# [15] "    -r 'http://cran.rstudio.com' \\"                                 
# [16] "    googleAuthR \\"                                                  
# [17] "    ## install Github packages"                                      
# [18] "    && Rscript -e \"devtools::install_github(c('bnosac/cronR'))\" \\"
# [19] "    ## clean up"                                                     
# [20] "    && rm -rf /tmp/downloaded_packages/ /tmp/*.rds \\" 

## build a new image based on rocker/hadleyverse with this Dockerfile
docker_build(vm, dockerfile = get_dockerfile("hadleyverse-crontab"), new_image = "my-cron-verse")

## wait for it to build (5mins +)
#...
#[0m ---> 059fe3ed926a
#Removing intermediate container 7695f3dc071f
#Successfully built 059fe3ed926a
#Using existing public key in /Users/mark/.ssh/google_compute_engine.pub
#REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE
#my-cron-verse        latest              059fe3ed926a        2 seconds ago       1.933 GB
#rocker/hadleyverse   latest              05e3b636e90b        24 hours ago        1.921 GB


## run the Rstudio instance with appropriate docker settings
docker_run(vm, 
          "my-cron-verse", 
          docker_opts = "-p 80:8787 -e 'ROOT=TRUE' -e USER=mark -e PASSWORD=mark1234 --name=myrstudio",
          detach = TRUE)

## log to the instance IP as given:
gce_get_external_ip(vm)
# External IP for instance build-test : 104.199.96.192

## setup scripts and cron jobs using library(cronR)
library(cronR)
cron_add("Rscript -e 'my-script.R'", "daily", at = "7AM")

## logout of RStudio

## locally - save the custom image to the Google repository for use in other VMs
gce_push_registry(vm, "my-cron-verse", container_name = "myrstudio")

gce_vm_stop(vm)

```

## Deploying a Shiny app 

```r



```


## Setting up an OpenCPU server with your custom packages

