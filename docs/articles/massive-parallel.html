<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Massively parallel processing â€¢ googleComputeEngineR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">googleComputeEngineR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/installation-and-authentication.html">Setup</a>
</li>
<li>
  <a href="../articles/creating-vms.html">Creating VMs</a>
</li>
<li>
  <a href="../articles/docker-ssh-futures.html">SSH</a>
</li>
<li>
  <a href="../articles/docker.html">Docker</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example-workflows.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/rstudio-team.html">Custom team RStudio Server</a>
    </li>
    <li>
      <a href="../articles/single-scheduler.html">RStudio Server + scheduler</a>
    </li>
    <li>
      <a href="../articles/shiny-app.html">Shiny App</a>
    </li>
    <li>
      <a href="../articles/opencpu-api-server.html">OpenCPU R API</a>
    </li>
    <li>
      <a href="../articles/scheduled-rscripts.html">Scheduled R scripts</a>
    </li>
    <li>
      <a href="../articles/massive-parallel.html">Massive parallel computing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Help
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html">Function Reference</a>
    </li>
    <li>
      <a href="../news/index.html">News</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://cloud.google.com/compute/">GCE Docs</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Massively parallel processing</h1>
                        <h4 class="author">Mark Edmondson</h4>
            
            <h4 class="date">2017-06-25</h4>
          </div>

    
    
<div class="contents">
<div id="run-massive-parallel-r-jobs-cheaply" class="section level1">
<h1 class="hasAnchor">
<a href="#run-massive-parallel-r-jobs-cheaply" class="anchor"></a>Run massive parallel R jobs cheaply</h1>
<p>Due to its integration with <a href="https://CRAN.R-project.org/package=future"><code>future</code></a> you can run massive computing tasks using a Google Compute Engine cluster with just a few lines of code.</p>
<p>Some <a href="http://www.jottr.org/2017/06/the-many-faced-future.html">more examples of using future</a> can be found here, using fractals as an example.</p>
<p>On other platforms, see also an <a href="http://blog.revolutionanalytics.com/2017/06/doazureparallel-updated.html">Azure example here on Revolution Analytics</a>.</p>
<div id="example-code" class="section level2">
<h2 class="hasAnchor">
<a href="#example-code" class="anchor"></a>Example code</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)
<span class="kw">library</span>(future)

## auto auth to GCE via environment file arguments

## create 50 preemptible CPUs as they are much cheaper
vm_names &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"cpu"</span>,<span class="dv">1</span>:<span class="dv">50</span>)

## specify the cheapest VMs that may get turned off
preemptible =<span class="st"> </span><span class="kw">list</span>(<span class="dt">preemptible =</span> <span class="ot">TRUE</span>)

## start up 50 VMs with R base on them (can customise via Dockerfiles)
fiftyvms &lt;-<span class="st"> </span><span class="kw">lapply</span>(vm_names, gce_vm, <span class="dt">predefined_type =</span> <span class="st">"n1-standard-1"</span>, <span class="dt">template =</span> <span class="st">"r-base"</span>, <span class="dt">scheduling =</span> preemptible)

## once all launched, add to cluster
<span class="kw">plan</span>(cluster, <span class="dt">workers =</span> fiftyvms)

## the action you want to perform via cluster
my_single_function &lt;-<span class="st"> </span>function(x){
  <span class="kw">an_expensive_function</span>(x)
}

## use future::future_lapply to send each call to the cluster
all_results &lt;-<span class="st"> </span><span class="kw">future_lapply</span>(<span class="dv">1</span>:<span class="dv">50</span>, my_single_function)

## tidy up
<span class="kw">lapply</span>(vms, <span class="dt">FUN =</span> gce_vm_stop)</code></pre></div>
</div>
<div id="pre-emptible-vms" class="section level2">
<h2 class="hasAnchor">
<a href="#pre-emptible-vms" class="anchor"></a>Pre-emptible VMs</h2>
<p><a href="https://cloud.google.com/preemptible-vms/">Preemptible VMs</a> are a lot cheaper (80%) than normal instances, but Google reserves the right to stop them at any time. They are intended to be used in non-critical jobs where if they shutdown you can account for it and launch another.</p>
<p>To create them, you need to pass <code>preemptible = list(preemptible = TRUE)</code> to the <code>scheduling</code>argument of the <code><a href="../reference/gce_vm.html">gce_vm()</a></code> creation family of functions.</p>
</div>
<div id="customising-the-vms-launched" class="section level2">
<h2 class="hasAnchor">
<a href="#customising-the-vms-launched" class="anchor"></a>Customising the VMs launched</h2>
<p>Using <code>Dockerfiles</code> and <code>gce_vm_template</code> or <code>gce_vm_container</code> you can customise the VMs launched. This can include shutdown scripts that fire if Google shuts down your preemptible instance early, allowing you to save results so far to Cloud storage or similar.</p>
</div>
<div id="authentication-upon-the-vms" class="section level2">
<h2 class="hasAnchor">
<a href="#authentication-upon-the-vms" class="anchor"></a>Authentication upon the VMs</h2>
<p>Since they are also running on Google Compute, you can authenticate with other cloud services such as BigQuery or Cloud Storage simply by using the <code>googleAuthR::gar_gce_auth()</code> function, which reuses the authentication that launched the VM.</p>
</div>
<div id="quotas" class="section level2">
<h2 class="hasAnchor">
<a href="#quotas" class="anchor"></a>Quotas</h2>
<p>You can launch as many VMs as you have <a href="https://cloud.google.com/compute/quotas">quota</a> for in your account. These vary from region, from ~240 to 720. You can apply for more quota if you need it.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#run-massive-parallel-r-jobs-cheaply">Run massive parallel R jobs cheaply</a><ul class="nav nav-pills nav-stacked">
<li><a href="#example-code">Example code</a></li>
      <li><a href="#pre-emptible-vms">Pre-emptible VMs</a></li>
      <li><a href="#customising-the-vms-launched">Customising the VMs launched</a></li>
      <li><a href="#authentication-upon-the-vms">Authentication upon the VMs</a></li>
      <li><a href="#quotas">Quotas</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
