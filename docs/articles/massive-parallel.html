<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Massively parallel processing • googleComputeEngineR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Massively parallel processing">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleComputeEngineR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/installation-and-authentication.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/creating-vms.html">
    <span class="fa fa-laptop"></span>
     
    Creating VMs
  </a>
</li>
<li>
  <a href="../articles/docker-ssh-futures.html">
    <span class="fa fa-terminal"></span>
     
    SSH
  </a>
</li>
<li>
  <a href="../articles/docker.html">
    <span class="fa fa-docker"></span>
     
    Docker
  </a>
</li>
<li>
  <a href="../articles/gpu.html">
    <span class="fa fa-memory"></span>
     
    GPUs
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example-workflows.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/rstudio-team.html">Custom team RStudio Server</a>
    </li>
    <li>
      <a href="../articles/persistent-rstudio.html">Persistent RStudio Server</a>
    </li>
    <li>
      <a href="../articles/single-scheduler.html">RStudio Server + scheduler</a>
    </li>
    <li>
      <a href="../articles/shiny-app.html">Shiny App</a>
    </li>
    <li>
      <a href="../articles/opencpu-api-server.html">OpenCPU R API</a>
    </li>
    <li>
      <a href="../articles/scheduled-rscripts.html">Scheduled R scripts</a>
    </li>
    <li>
      <a href="../articles/massive-parallel.html">Massive parallel computing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Help
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html">Function Reference</a>
    </li>
    <li>
      <a href="../news/index.html">News</a>
    </li>
    <li>
      <a href="../articles/troubleshooting.html">Troubleshooting</a>
    </li>
    <li>
      <a href="https://cloud.google.com/compute/">
        <span class="fa fa-google"></span>
         
        GCE Homepage
      </a>
    </li>
    <li>
      <a href="https://github.com/cloudyr/googleComputeEngineR">
        <span class="fa fa-github"></span>
         
        GitHub
      </a>
    </li>
    <li>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSerjirmMpB3b7LmBs_Vx_XPIE9IrhpCpPg1jUcpfBcivA3uBw/viewform">
        <span class="fa fa-slack"></span>
         
        Slack channel
      </a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Massively parallel processing</h1>
                        <h4 class="author">Mark Edmondson</h4>
            
            <h4 class="date">2019-11-09</h4>
      
      
      <div class="hidden name"><code>massive-parallel.Rmd</code></div>

    </div>

    
    
<div id="run-massive-parallel-r-jobs-cheaply" class="section level1">
<h1 class="hasAnchor">
<a href="#run-massive-parallel-r-jobs-cheaply" class="anchor"></a>Run massive parallel R jobs cheaply</h1>
<p>Due to its integration with <a href="https://CRAN.R-project.org/package=future"><code>future</code></a> you can run massive computing tasks using a Google Compute Engine cluster with just a few lines of code.</p>
<p>Some <a href="http://www.jottr.org/2017/06/the-many-faced-future.html">more examples of using future</a> can be found here, using fractals as an example.</p>
<p>On other platforms, see also an <a href="http://blog.revolutionanalytics.com/2017/06/doazureparallel-updated.html">Azure example here on Revolution Analytics</a>.</p>
</div>
<div id="remote-r-cluster" class="section level1">
<h1 class="hasAnchor">
<a href="#remote-r-cluster" class="anchor"></a>Remote R cluster</h1>
<p>This workflow takes advantage of the <a href="https://CRAN.R-project.org/package=future"><code>future</code></a> integration to run your local R-functions within a cluster of GCE machines.<br>
You can do this to throw up expensive computations by spinning up a cluster and tearing it down again once you are done.</p>
<p>In summary, this workflow:</p>
<ol style="list-style-type: decimal">
<li>Creates a GCE cluster</li>
<li>Lets you perform computations</li>
<li>Stops the VMs</li>
</ol>
<div id="create-the-cluster" class="section level3">
<h3 class="hasAnchor">
<a href="#create-the-cluster" class="anchor"></a>Create the cluster</h3>
<p>The example below uses a default <code>rocker/r-parallel</code> template, but you can also create a <code>dynamic_template</code> pulled from the Container Registry if required.</p>
<p>Instead of the more generic <code><a href="../reference/gce_vm.html">gce_vm()</a></code> that is used for more interactive use, we create the instances directly using <code><a href="../reference/gce_vm_cluster.html">gce_vm_cluster()</a></code>.</p>
<p>This creates a cluster, uploads any SSH settings you have and tests the connection, then returns the list of VMs suitable for use in <code><a href="https://www.rdocumentation.org/packages/future/topics/cluster">future::cluster()</a></code>.</p>
<p>By default it makes a 3 size cluster called <code>r-cluster-1/2/3</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(future)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(googleComputeEngineR)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">vms &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gce_vm_cluster.html">gce_vm_cluster</a></span>()</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#2019-03-29 23:24:54&gt; # Creating cluster with these arguments:template = r-base,dynamic_image = rocker/r-parallel,wait = #FALSE,predefined_type = n1-standard-1</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#2019-03-29 23:25:04&gt; Operation running...</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#2019-03-29 23:25:07&gt; Operation running...</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#2019-03-29 23:25:10&gt; Operation running...</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co">#2019-03-29 23:25:17&gt; Operation complete in 13 secs</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co">#2019-03-29 23:25:20&gt; Operation complete in 13 secs</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co">#2019-03-29 23:25:23&gt; Operation complete in 14 secs</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co">#2019-03-29 23:25:25&gt; r-cluster-1 VM running</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="co">#2019-03-29 23:25:27&gt; r-cluster-2 VM running</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co">#2019-03-29 23:25:29&gt; r-cluster-3 VM running</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co">#2019-03-29 23:25:37&gt; Public SSH key uploaded to instance</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="co">#2019-03-29 23:25:45&gt; Public SSH key uploaded to instance</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="co">#2019-03-29 23:25:53&gt; Public SSH key uploaded to instance</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="co">#2019-03-29 23:25:53&gt; # Testing cluster:</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="co">#Warning: Permanently added '35.233.25.199' (ED25519) to the list of known hosts.</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">r<span class="op">-</span>cluster<span class="dv">-1</span> ssh working</a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="co">#Warning: Permanently added '35.187.54.41' (ED25519) to the list of known hosts.</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">r<span class="op">-</span>cluster<span class="dv">-2</span> ssh working</a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="co">#Warning: Permanently added '35.205.66.124' (ED25519) to the list of known hosts.</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">r<span class="op">-</span>cluster<span class="dv">-3</span> ssh working</a></code></pre></div>
<p>We now make the VM cluster as per details given in the <a href="https://github.com/HenrikBengtsson/future">future README</a></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">## make a future cluster</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">plan</span>(cluster, <span class="dt">workers =</span> <span class="kw">as.cluster</span>(vms))</a></code></pre></div>
<p>You can pass in your own arguments to <code><a href="../reference/gce_vm_cluster.html">gce_vm_cluster()</a></code> such as which docker image to use, name and custom SSH arguments you may have. See the function documentation for details.</p>
</div>
<div id="using-your-own-docker-image" class="section level3">
<h3 class="hasAnchor">
<a href="#using-your-own-docker-image" class="anchor"></a>Using your own Docker image</h3>
<p>The default uses <code>rocker/r-parallel</code> as its image, but if you want your own custom image then create your own Docker image based on that one, for example via <a href="articles/docker.html#build-triggers">this tutorial using Google Build Triggers</a>.</p>
<p>This will give you a docker image name such as <code>gcr.io/my-project/my-r</code> - use a version of the code below to use this in your cluster.</p>
<p>You can also customise the <code>RScript</code> command that launches your script, but always make sure to include <code>--net=host</code> as is shown in the default arguments, so the Docker image uses the SSH ports the host VM has (e.g. it can connect to your SSH commands)</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">plan</span>(cluster, <span class="dt">workers =</span> <span class="kw">as.cluster</span>(vms, <span class="dt">docker_image=</span><span class="st">"gcr.io/my-project/my-r"</span>))</a></code></pre></div>
</div>
<div id="using-the-cluster" class="section level3">
<h3 class="hasAnchor">
<a href="#using-the-cluster" class="anchor"></a>Using the cluster</h3>
<p>The cluster is now ready to recieve jobs. You can send them by simply using <code>%&lt;-%</code> instead of <code>&lt;-</code>. Another useful function is <code><a href="https://www.rdocumentation.org/packages/future.apply/topics/future_lapply">future.apply::future_lapply</a></code> that lets you loop over a cluster. Consult the <a href="https://github.com/HenrikBengtsson/future.apply"><code>future.apply</code> documentation</a> for details.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">## use %&lt;-% to send functions to work on cluster</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">## See future README for details: https://github.com/HenrikBengtsson/future</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">a <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.getpid">Sys.getpid</a></span>()</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">## make a big function to run asynchronously</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">f &lt;-<span class="st"> </span><span class="cf">function</span>(my_data, args){</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">   <span class="co">## ....expensive...computations</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">   </a>
<a class="sourceLine" id="cb4-9" data-line-number="9">   result</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">## send to cluster</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">result <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">f</span>(my_data) </a></code></pre></div>
<p>For long running jobs you can use <code><a href="https://www.rdocumentation.org/packages/future/topics/resolved">future::resolved</a></code> to check on its progress.</p>
<pre><code>## check if resolved
resolved(result)
[1] TRUE</code></pre>
</div>
<div id="nested-parallelization" class="section level3">
<h3 class="hasAnchor">
<a href="#nested-parallelization" class="anchor"></a>Nested parallelization</h3>
<p>(Contributed by <a href="https://twitter.com/grant_mcdermott">Grant McDermott</a>.)</p>
<p>The above setup will parallelize across the VMs in your cluster. However, each VM will still only run tasks sequentially. In order to parallelize tasks on the VMs too, we need to tell our remote cluster (via <code>future</code>) to use a nested parallelization strategy. At a high level this will involve two steps:</p>
<ol style="list-style-type: decimal">
<li>Parallelization across the remote VMs in our cluster.</li>
<li>Parallelization within each VM, making sure that we “chunk” the input data appropriately to avoid duplication.</li>
</ol>
<p>To illustrate, consider an example where we wish to run a slow function across a cluster of three VMs that each have eight cores (yielding 24 cores in total). We again use <code><a href="../reference/gce_vm_cluster.html">gce_vm_cluster()</a></code> to set this up. Note in passing that the default instantiation of the rocker/r-parallel Docker image on each VM is what allows us to run parallel processes on these machines themselves without having to install any additional packages.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(googleComputeEngineR)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(future.apply)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">## Emulate a slow function that can be sped up in parallel</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">slow_square &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="st">  </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    x_sq &lt;-<span class="st"> </span>x<span class="op">^</span><span class="dv">2</span> </a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.sleep">Sys.sleep</a></span>(<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(x_sq)</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    }</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="co">## Set up our cluster: 3 VMs with 8 cores each</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">vms_nested &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="st">  </span><span class="kw"><a href="../reference/gce_vm_cluster.html">gce_vm_cluster</a></span>(</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">    <span class="dt">vm_prefix =</span> <span class="st">"nested-cluster"</span>,        </a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    <span class="dt">cluster_size =</span> <span class="dv">3</span>,                    </a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    <span class="co">#docker_image = "rocker/r-parallel",  ## Default </span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18">    <span class="dt">predefined_type =</span> <span class="st">"n1-highcpu-8"</span>,     </a>
<a class="sourceLine" id="cb6-19" data-line-number="19">    <span class="dt">scheduling =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">preemptible =</span> <span class="ot">TRUE</span>) <span class="co">## Optional: Use cheaper, preemptible machines</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20">    )</a>
<a class="sourceLine" id="cb6-21" data-line-number="21"></a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="co">#2019-10-25 12:56:21&gt; # Creating cluster with settings: predefined_type = n1-highcpu-8, scheduling = list(preemptible = TRUE), template = r-base, dynamic_image = rocker/r-parallel, wait = FALSE</span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="co">#2019-10-25 12:56:29&gt; Operation running...</span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="co">#2019-10-25 12:56:35&gt; Operation complete in 6 secs</span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="co">#2019-10-25 12:56:38&gt; Operation complete in 4 secs</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26"><span class="co">#2019-10-25 12:56:42&gt; Operation complete in 6 secs</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="co">#2019-10-25 12:56:43&gt; nested-cluster1 VM running</span></a>
<a class="sourceLine" id="cb6-28" data-line-number="28"><span class="co">#2019-10-25 12:56:44&gt; nested-cluster2 VM running</span></a>
<a class="sourceLine" id="cb6-29" data-line-number="29"><span class="co">#2019-10-25 12:56:46&gt; nested-cluster3 VM running</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30"><span class="co">#2019-10-25 12:56:54&gt; Public SSH key uploaded to instance</span></a>
<a class="sourceLine" id="cb6-31" data-line-number="31"><span class="co">#2019-10-25 12:57:01&gt; Public SSH key uploaded to instance</span></a>
<a class="sourceLine" id="cb6-32" data-line-number="32"><span class="co">#2019-10-25 12:57:09&gt; Public SSH key uploaded to instance</span></a>
<a class="sourceLine" id="cb6-33" data-line-number="33"><span class="co">#2019-10-25 12:57:09&gt; # Testing cluster:</span></a>
<a class="sourceLine" id="cb6-34" data-line-number="34"><span class="co">#Warning: Permanently added 'XX.XX.XX.XXX' (ED25519) to the list of known hosts.</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"><span class="co">#nested-cluster1 ssh working</span></a>
<a class="sourceLine" id="cb6-36" data-line-number="36"><span class="co">#Warning: Permanently added 'YY.YY.YYY.YY' (ED25519) to the list of known hosts.</span></a>
<a class="sourceLine" id="cb6-37" data-line-number="37"><span class="co">#nested-cluster2 ssh working</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38"><span class="co">#Warning: Permanently added 'ZZ.ZZ.ZZZ.ZZ' (ED25519) to the list of known hosts.</span></a>
<a class="sourceLine" id="cb6-39" data-line-number="39"><span class="co">#nested-cluster3 ssh working</span></a></code></pre></div>
<p>Next, we must tweak the cluster plan so that <code>future</code> is aware of the nested parallel structure. Nesting in the <code>future</code> framework is operationalised by defining a series of so-called <a href="https://cran.r-project.org/web/packages/future/vignettes/future-3-topologies.html">future “topologies”</a>. In this case, we are going to define two topology layers:</p>
<ul>
<li>
<strong>Topology 1.</strong> The “outer” plan, which tells <code>future</code> to use the cluster of three remote VMs.</li>
<li>
<strong>Topology 2.</strong> The “inner” plan, which tells <code>future</code> to use all eight cores on each VM via the <code>multiprocess</code> option.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">plan</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>( </a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  <span class="co">## Topology 1: Use the cluster of remote VMs </span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="kw">tweak</span>(cluster, <span class="dt">workers =</span> <span class="kw">as.cluster</span>(vms_nested)),  </a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="co">## Topology 2: Use all CPUs on each VM</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="kw">tweak</span>(multiprocess)  </a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  ))</a></code></pre></div>
<p>The final thing that we’ll do before using our cluster is defining a convenience function for chunking the input arguments (i.e. data) to our function. Remember, we need to do this or else each VM will duplicate effort by working on the same parts of the problem. R provides lots of ways to split data into chunks, but here’s one that I’ve borrowed from <a href="https://stackoverflow.com/a/16275428">StackOverflow</a>. The advantages of this particular function are that it only requires base R operations and is robust to complications like unequal chunk lengths and different input types (e.g. factors vs numeric).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">chunk_func &lt;-<span class="st"> </span><span class="cf">function</span>(x, n) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/split">split</a></span>(x, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cut">cut</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_along</a></span>(x), n, <span class="dt">labels =</span> <span class="ot">FALSE</span>)) </a></code></pre></div>
<p>We are now ready to use all 24 cores of the cluster. For this particular example, I’m going to loop over 48 iterations of our <code>slow_square()</code> function. (Note that this would take two minutes to run sequentially.) I’ll use <code>future.lapply::future_sapply()</code> to run things in parallel and will also use the <code>tictoc</code> package to record timing. I’m going to comment the next code block quite extensively, but just to quickly highlight the key conceptual stages:</p>
<ul>
<li>First, we’ll parallelize across the three VMs in our cluster via an outer <code><a href="https://www.rdocumentation.org/packages/future.apply/topics/future_lapply">future_sapply()</a></code> call.</li>
<li>Next, we’ll split our input data into chunks so that each VM could work on a separate part of the problem (i.e. VM1 gets <code>1:16</code>, VM2 gets <code>17:32</code>, and VM3 gets <code>33:48</code>)</li>
<li>Finally, we’ll parallelize internally so that each VM uses all of its available cores via an inner <code><a href="https://www.rdocumentation.org/packages/future.apply/topics/future_lapply">future_sapply()</a></code> call.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co">## Input data (vector to be iterated over by our function)</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">input_data &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">48</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">## Run the function in nested parallel on our cluster and record timing</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">tictoc<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tictoc/topics/tic">tic</a></span>()</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">ans &lt;-</a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="st">   </span><span class="co">## Parallelise over the three VMS</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="st">   </span><span class="kw"><a href="https://www.rdocumentation.org/packages/future.apply/topics/future_lapply">future_sapply</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_along</a></span>(vms_nested), <span class="cf">function</span>(v) {</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">   </a>
<a class="sourceLine" id="cb9-10" data-line-number="10">      <span class="co">## Split the input data into distinct chunks for each VM</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">      input_chunk &lt;-<span class="st"> </span><span class="kw">chunk_func</span>(input_data, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(vms_nested))[[v]] </a>
<a class="sourceLine" id="cb9-12" data-line-number="12">   </a>
<a class="sourceLine" id="cb9-13" data-line-number="13">      <span class="co">## Parallelise within each of the VMs  </span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">      <span class="kw"><a href="https://www.rdocumentation.org/packages/future.apply/topics/future_lapply">future_sapply</a></span>(input_chunk, slow_square)</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">   })</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">tictoc<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tictoc/topics/tic">toc</a></span>()</a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co">#11.451 sec elapsed</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"></a>
<a class="sourceLine" id="cb9-19" data-line-number="19"><span class="co">## Show that it worked</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">as.vector</a></span>(ans)</a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="co"># [1]    1    4    9   16   25   36   49   64   81  100  121  144  169  196  225</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="co">#[16]  256  289  324  361  400  441  484  529  576  625  676  729  784  841  900</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23"><span class="co">#[31]  961 1024 1089 1156 1225 1296 1369 1444 1521 1600 1681 1764 1849 1936 2025</span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24"><span class="co">#[46] 2116 2209 2304</span></a></code></pre></div>
<p>And there you have it: a 21x speed up compared to the sequential option. (There’s a tiny bit of overhead, which is why we don’t achieve the full theoretical speed-up of 24x. But those margins will improve as the scale of the problem increases.) The same general approach demonstrated here can be adapted fairly easily to greatly reduce computation times for even complex forms of analysis.</p>
<p>Since we have been using preemptible machines for this example, they will automatically be deleted within 24 hours. However, we’ll delete them manaully since there’s no point incurring additional charges now that we’re done with them.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/gce_vm_delete.html">gce_vm_delete</a></span>(vms_nested)</a></code></pre></div>
</div>
<div id="more-examples" class="section level2">
<h2 class="hasAnchor">
<a href="#more-examples" class="anchor"></a>More examples</h2>
<div id="forecasting-a-large-data-set" class="section level3">
<h3 class="hasAnchor">
<a href="#forecasting-a-large-data-set" class="anchor"></a>Forecasting a large data set</h3>
<p>The below splits a dataset into chunks that are each run on a seperate VMs, using a custom Docker image that has the necessary packages installed, for instance via <a href="articles/docker.html#build-triggers">build triggers</a>. Optimise by including the package <code>future</code> in these Docker images.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(future.apply) <span class="co">## Will automatically load future too</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(googleComputeEngineR)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">my_docker &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gce_tag_container.html">gce_tag_container</a></span>(<span class="st">"custom-image"</span>, <span class="dt">project =</span> <span class="st">"my-project"</span>)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">vms &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gce_vm_cluster.html">gce_vm_cluster</a></span>(<span class="st">"r-vm"</span>, <span class="dt">cluster_size =</span> <span class="dv">3</span>, <span class="dt">docker_image =</span> my_docker)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">                </a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">## create the future cluster</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="kw">plan</span>(cluster, </a>
<a class="sourceLine" id="cb11-10" data-line-number="10">     <span class="dt">workers =</span> <span class="kw">as.cluster</span>(vms, </a>
<a class="sourceLine" id="cb11-11" data-line-number="11">                          <span class="dt">docker_image=</span>my_docker))</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">                          </a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">## create the list of data to run on the cluster</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">## here we assume they are in a folder of CSVs</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co">## and there are as many files as VMs to run it upon</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16">my_files &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(<span class="st">"myfolder"</span>)</a>
<a class="sourceLine" id="cb11-17" data-line-number="17"></a>
<a class="sourceLine" id="cb11-18" data-line-number="18">my_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(my_files, read.csv)</a>
<a class="sourceLine" id="cb11-19" data-line-number="19"></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">## make a big function to run asynchronously</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21">cluster_f &lt;-<span class="st"> </span><span class="cf">function</span>(my_data, <span class="dt">args =</span> <span class="dv">4</span>){</a>
<a class="sourceLine" id="cb11-22" data-line-number="22">   </a>
<a class="sourceLine" id="cb11-23" data-line-number="23">   forecast<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/forecast/topics/forecast">forecast</a></span>(forecast<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/forecast/topics/auto.arima">auto.arima</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/ts">ts</a></span>(my_data, <span class="dt">frequency =</span> args)))</a>
<a class="sourceLine" id="cb11-24" data-line-number="24">   </a>
<a class="sourceLine" id="cb11-25" data-line-number="25">}</a>
<a class="sourceLine" id="cb11-26" data-line-number="26"></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="co">## send to cluster</span></a>
<a class="sourceLine" id="cb11-28" data-line-number="28">result &lt;-<span class="st"> </span>future.apply<span class="op">::</span><span class="kw">future_lapply</span>(my_data, cluster_f, <span class="dt">args =</span> <span class="dv">4</span>) </a>
<a class="sourceLine" id="cb11-29" data-line-number="29"></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="co">## once done this will be TRUE</span></a>
<a class="sourceLine" id="cb11-31" data-line-number="31"><span class="kw">resolved</span>(result)</a>
<a class="sourceLine" id="cb11-32" data-line-number="32"></a>
<a class="sourceLine" id="cb11-33" data-line-number="33"><span class="co">## Your list of forecasts are now available</span></a>
<a class="sourceLine" id="cb11-34" data-line-number="34">result</a></code></pre></div>
</div>
<div id="rasters-in-parallel" class="section level3">
<h3 class="hasAnchor">
<a href="#rasters-in-parallel" class="anchor"></a>Rasters in parallel</h3>
<p>This is from <span class="citation">@ctlamb</span>’s <a href="https://github.com/cloudyr/googleComputeEngineR/issues/93">GitHub issue #93</a> which uses a custom Dockerfile to install the raster package.</p>
<p>The custom Dockerfile was setup in this <a href="https://github.com/MarkEdmondson1234/raster">GitHub repo</a> then made into an image with these Build Trigger settings:</p>
<p><img src="https://user-images.githubusercontent.com/3155884/36549126-494a99ca-17f2-11e8-8338-f5769a629749.png"></p>
<p>Make sure the VMs are created in the same project as the build triggers to ensure authentication is smooth.</p>
<p>The example code is shown below, assuming your custom Docker image is available at <code>gcr.io/your-project/raster</code></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(raster)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(googleComputeEngineR)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(future)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(future.apply)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(SpaDES.tools)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="kw"><a href="../reference/gce_global_project.html">gce_global_project</a></span>(<span class="st">"your-project"</span>)</a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">## create raster</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">row &lt;-<span class="st"> </span><span class="dv">8</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11">col &lt;-<span class="st"> </span><span class="dv">8</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12">r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">nrows=</span>row, <span class="dt">ncols=</span>col,</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">            <span class="dt">xmn=</span><span class="dv">0</span>, <span class="dt">xmx=</span>row, </a>
<a class="sourceLine" id="cb12-14" data-line-number="14">            <span class="dt">ymn=</span><span class="dv">0</span>, <span class="dt">ymx=</span>col, </a>
<a class="sourceLine" id="cb12-15" data-line-number="15">            <span class="dt">vals=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span><span class="op">:</span>(row<span class="op">*</span>col)))</a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(r)</a>
<a class="sourceLine" id="cb12-17" data-line-number="17"></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">## Split</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19">r_split &lt;-<span class="st"> </span><span class="kw">splitRaster</span>(r, <span class="dt">nx=</span><span class="dv">2</span>, <span class="dt">ny=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb12-20" data-line-number="20"></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">## create model</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22">df &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">y=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>),<span class="dt">layer=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">6</span>,<span class="dv">8</span><span class="op">:</span><span class="dv">10</span>))</a>
<a class="sourceLine" id="cb12-23" data-line-number="23">mod &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/glm">glm</a></span>(y<span class="op">~</span>layer, <span class="dt">data=</span>df)</a>
<a class="sourceLine" id="cb12-24" data-line-number="24"></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="co">## create CPUs names - here we customise the CPU machine type</span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27">vms &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gce_vm_cluster.html">gce_vm_cluster</a></span>(<span class="st">"myvms"</span>, <span class="dt">predefined_type =</span> <span class="st">"n1-highmem-2"</span>)</a>
<a class="sourceLine" id="cb12-28" data-line-number="28"></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="co">## once all launched, add to cluster with custom Dockerfile</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="co">## use plan(sequential) for local testing</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="kw">plan</span>(cluster, <span class="dt">workers =</span> <span class="kw">as.cluster</span>(vms, <span class="dt">docker_image=</span>my_image)</a>
<a class="sourceLine" id="cb12-32" data-line-number="32"></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="co">## make the vector of stuff to send to nodes</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34">o &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(r_split, readAll)</a>
<a class="sourceLine" id="cb12-35" data-line-number="35"></a>
<a class="sourceLine" id="cb12-36" data-line-number="36"><span class="co">## the action you want to perform on the elements in the cluster</span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37">my_single_function &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb12-38" data-line-number="38">  raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/predict">predict</a></span>(x, mod)</a>
<a class="sourceLine" id="cb12-39" data-line-number="39">}</a>
<a class="sourceLine" id="cb12-40" data-line-number="40"></a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="co">#parallel - working?</span></a>
<a class="sourceLine" id="cb12-42" data-line-number="42">result &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/future.apply/topics/future_lapply">future_lapply</a></span>(o, my_single_function)</a>
<a class="sourceLine" id="cb12-43" data-line-number="43"></a>
<a class="sourceLine" id="cb12-44" data-line-number="44"><span class="co">## tidy up</span></a>
<a class="sourceLine" id="cb12-45" data-line-number="45"><span class="kw"><a href="../reference/gce_vm_stop.html">gce_vm_stop</a></span>(vms)</a></code></pre></div>
</div>
<div id="cleanup" class="section level3">
<h3 class="hasAnchor">
<a href="#cleanup" class="anchor"></a>Cleanup</h3>
<p>Remember to shut down your cluster. You are charged per second, per instance of uptime.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co">## shutdown instances when finished</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="../reference/gce_vm_stop.html">gce_vm_stop</a></span>(vms)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co"># or delete them</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="kw"><a href="../reference/gce_vm_delete.html">gce_vm_delete</a></span>(vms)</a></code></pre></div>
</div>
<div id="pre-emptible-vms" class="section level3">
<h3 class="hasAnchor">
<a href="#pre-emptible-vms" class="anchor"></a>Pre-emptible VMs</h3>
<p><a href="https://cloud.google.com/preemptible-vms/">Preemptible VMs</a> are a lot cheaper (80%) than normal instances, but Google reserves the right to stop them at any time. They are intended to be used in non-critical jobs where if they shutdown you can account for it and launch another.</p>
<p>To create them, you need to pass <code>scheduling = list(preemptible = TRUE)</code> to <code><a href="../reference/gce_vm_create.html">gce_vm_create()</a></code> creation family of functions.</p>
<p>Make sure you can cope with the result may not be returned, so over provision the VMs and ensure your script can deal with redoing jobs if they didn’t complete.</p>
</div>
</div>
<div id="quotas" class="section level2">
<h2 class="hasAnchor">
<a href="#quotas" class="anchor"></a>Quotas</h2>
<p>You can launch as many VMs as you have <a href="https://cloud.google.com/compute/quotas">quota</a> for in your account. These vary from region, from ~240 to 720. You can apply for more quota if you need it.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#run-massive-parallel-r-jobs-cheaply">Run massive parallel R jobs cheaply</a></li>
      <li>
<a href="#remote-r-cluster">Remote R cluster</a><ul class="nav nav-pills nav-stacked">
<li><a href="#more-examples">More examples</a></li>
      <li><a href="#quotas">Quotas</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://code.markedmondson.me">Mark Edmondson</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
