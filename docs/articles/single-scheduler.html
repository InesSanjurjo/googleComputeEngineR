<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scheduled RStudio • googleComputeEngineR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">googleComputeEngineR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/installation-and-authentication.html">Setup</a>
</li>
<li>
  <a href="../articles/creating-vms.html">Creating VMs</a>
</li>
<li>
  <a href="../articles/docker-ssh-futures.html">SSH &amp; Docker</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example-workflows.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/rstudio-team.html">Custom team RStudio Server</a>
    </li>
    <li>
      <a href="../articles/single-scheduler.html">RStudio Server + scheduler</a>
    </li>
    <li>
      <a href="../articles/shiny-app.html">Shiny App</a>
    </li>
    <li>
      <a href="../articles/opencpu-api-server.html">OpenCPU R API</a>
    </li>
    <li>
      <a href="../articles/scheduled-rscripts.html">Scheduled cron master/slave</a>
    </li>
    <li>
      <a href="../articles/massive-parallel.html">Massive parallel computing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Help
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html">Reference</a>
    </li>
    <li>
      <a href="../news/index.html">News</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://cloud.google.com/compute/">Google Compute Engine</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Scheduled RStudio</h1>
                        <h4 class="author">Mark Edmondson</h4>
            
            <h4 class="date">2017-06-18</h4>
          </div>

    
    
<div class="contents">
<p>See also scheduling via a <a href="scheduled-rscripts.html">master/slave cluster</a></p>
<div id="rstudio-server-scheduler" class="section level1">
<h1 class="hasAnchor">
<a href="#rstudio-server-scheduler" class="anchor"></a>RStudio server + scheduler</h1>
<p>This workflow demonstrates how you can take advantage of premade <code>Docker</code> images. <code>googleComputeEngineR</code> has created custom images that have been built using Google Container Registry build triggers and made public, which you can use.</p>
<div id="tldr" class="section level2">
<h2 class="hasAnchor">
<a href="#tldr" class="anchor"></a>TL;DR</h2>
<p>Run this, and you get an RStudio server instance running with <code>cronR</code>, the <code>tidyverse</code>and <code>googleAnalyticsR</code> etc. running on it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)
## set up and authenticate etc...

## get tag name of public pre-made image
tag &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gce_tag_container.html">gce_tag_container</a></span>(<span class="st">"google-auth-r-cron-tidy"</span>, <span class="dt">project =</span> <span class="st">"gcer-public"</span>)

## rstudio template, but with custom rstudio build with cron, googleAuthR etc. 
vm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gce_vm.html">gce_vm</a></span>(<span class="st">"rstudio-cron-googleauthr"</span>, 
              <span class="dt">predefined_type =</span> <span class="st">"n1-standard-1"</span>,
              <span class="dt">template =</span> <span class="st">"rstudio"</span>, 
              <span class="dt">dynamic_image =</span> tag, 
              <span class="dt">username =</span> <span class="st">"mark"</span>, 
              <span class="dt">password =</span> <span class="st">"mark1234"</span>)</code></pre></div>
</div>
<div id="how-to-customise-your-own-rstudio-server" class="section level2">
<h2 class="hasAnchor">
<a href="#how-to-customise-your-own-rstudio-server" class="anchor"></a>How to customise your own RStudio Server</h2>
<p>Using <code>Dockerfiles</code> is recommended if you are making a lot of changes to a template, as its a lot easier to keep track on what is happening.</p>
<p>In summary, these were the steps I took:</p>
<ol style="list-style-type: decimal">
<li>Construct a <code>Dockerfile</code> in a folder with any other files or dependencies, such as cron</li>
<li>Use <code><a href="../reference/docker_build.html">docker_build()</a></code> or <a href="https://cloud.google.com/container-builder/docs/concepts/creating-build-triggers">Google Container build triggers</a> to build and save your custom Docker image</li>
<li>Launch a VM using the <code>dynamic_image</code> argument to load from the custom image</li>
<li>Schedule a script to download from Google Analytics, send an email and upload to BigQuery</li>
</ol>
<p>You can modify this with your own <code>Dockerfile</code> to use your own custom packages, libraries etc. and load up to your own private Container Registry, that comes with every Google Cloud project.</p>
<div id="construct-a-dockerfile" class="section level3">
<h3 class="hasAnchor">
<a href="#construct-a-dockerfile" class="anchor"></a>Construct a <em>Dockerfile</em>
</h3>
<p>The <code>Dockerfile</code> used here is shown below, which you could base your own upon. Read up on <a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Dockerfile’s here</a>.</p>
<p>This one installs <code>cron</code> for scheduling, and <code>nano</code> a simple text editor. It then also installs some libraries needed for my scheduled scripts:</p>
<ul>
<li>
<code>googleAuthR</code> - google authentication</li>
<li>
<code>shinyFiles</code> - for cron jobs</li>
<li>
<code>googleCloudStorageR</code> - for uploading to Google Cloud Storage</li>
<li>
<code>bigQueryR</code> - for uploading to BigQuery</li>
<li>
<code>gmailR</code> - an email R package</li>
<li>
<code>googleAnalyticsR</code> - for downloading Google Analytics data</li>
<li>
<code>bnosac/cronR</code> - to help with creating cron jobs within RStudio.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">FROM</span> rocker/tidyverse
<span class="kw">MAINTAINER</span> Mark Edmondson (r@sunholo.com)

<span class="co"># install cron and R package dependencies</span>
<span class="kw">RUN</span> apt-get update <span class="kw">&amp;&amp;</span> <span class="kw">apt-get</span> install -y \
    cron \
    nano \
    <span class="co">## clean up</span>
    <span class="kw">&amp;&amp;</span> <span class="kw">apt-get</span> clean <span class="dt">\ </span>
    <span class="kw">&amp;&amp;</span> <span class="kw">rm</span> -rf /var/lib/apt/lists/ <span class="dt">\ </span>
    <span class="kw">&amp;&amp;</span> <span class="kw">rm</span> -rf /tmp/downloaded_packages/ /tmp/*.rds
    
<span class="co">## Install packages from CRAN</span>
<span class="kw">RUN</span> install2.r --error <span class="dt">\ </span>
    <span class="kw">-r</span> <span class="st">'http://cran.rstudio.com'</span> \
    googleAuthR shinyFiles googleCloudStorageR bigQueryR gmailr googleAnalyticsR \
    <span class="co">## install Github packages</span>
    <span class="kw">&amp;&amp;</span> <span class="kw">Rscript</span> -e <span class="st">"devtools::install_github(c('bnosac/cronR'))"</span> \
    <span class="co">## clean up</span>
    <span class="kw">&amp;&amp;</span> <span class="kw">rm</span> -rf /tmp/downloaded_packages/ /tmp/*.rds \

<span class="co">## Start cron</span>
<span class="kw">RUN</span> sudo service cron start</code></pre></div>
</div>
<div id="create-a-container-registry-build-trigger" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-container-registry-build-trigger" class="anchor"></a>Create a Container Registry build trigger</h3>
<p>A build trigger was then created following the <a href="https://cloud.google.com/container-builder/docs/concepts/creating-build-triggers">guide here</a>.</p>
<p>In this case, the GitHub repository used was <code>googleComputeEngineR</code>’s own, and the <code>inst/dockerfiles/hadleyverse-crontab</code> pointed at to watch for building the images. The image was saved under the name <code>google-auth-r-cron-tidy</code> and (optionally) made public via <a href="https://cloud.google.com/container-registry/docs/access-control">this procedure</a>.</p>
<ul>
<li>Make sure the build tags are all lowercase-or-hypens</li>
<li>Add the <code>latest</code> tag to the name to ensure it can be pulled upon VM launch</li>
</ul>
<p>Push to the GitHub repository and you should start to see the image being built in the <a href="https://console.cloud.google.com/gcr/builds">build history section</a>. If there are any problems you can click through to the log and modify your Dockerfile as needed. It also works with <code>cloud-config</code> files if you are looking to set up the VM beyond a <code>Dockerfile</code>.</p>
</div>
<div id="launch-a-vm-to-run-your-custom-image" class="section level3">
<h3 class="hasAnchor">
<a href="#launch-a-vm-to-run-your-custom-image" class="anchor"></a>Launch a VM to run your custom image</h3>
<p>Once built, you can now launch instances using the constructed image.</p>
<p>In this case the image project is different from the project the VM is created in, so the project needs specifing in the <code>gce_tag_container</code> call.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## get tag name of public pre-made image
tag &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gce_tag_container.html">gce_tag_container</a></span>(<span class="st">"hadleyverse-crontab"</span>, <span class="dt">project =</span> <span class="st">"gcer-public"</span>)

## rstudio template, but with custom rstudio build with cron, googleAuthR etc. 
vm2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gce_vm.html">gce_vm</a></span>(<span class="st">"rstudio-cron-googleauthr"</span>, 
              <span class="dt">predefined_type =</span> <span class="st">"n1-standard-1"</span>,
              <span class="dt">template =</span> <span class="st">"rstudio"</span>, 
              <span class="dt">dynamic_image =</span> tag, 
              <span class="dt">username =</span> <span class="st">"mark"</span>, 
              <span class="dt">password =</span> <span class="st">"mark1234"</span>)</code></pre></div>
<p>You can also use your custom image to create further <code>Dockerfiles</code> that use it as a dependency, using <code><a href="../reference/gce_tag_container.html">gce_tag_container()</a></code> to get its correct name.</p>
</div>
<div id="a-demo-script" class="section level3">
<h3 class="hasAnchor">
<a href="#a-demo-script" class="anchor"></a>A demo script</h3>
<p>A demo script for scheduling is below.</p>
<p>It is not recommended to put critical data within a Docker contianer, as it can be destroyed if the container crashes. Instead, call dedicated data stores such as BigQuery or Cloud Storage, which as you are using Google Compute Engine you already have access to under the same project.</p>
<p>In summary the script below:</p>
<ol style="list-style-type: decimal">
<li>Downloads data from Google Analytics</li>
<li>Uploads the data to BigQuery</li>
<li>Uploads the data to Google Cloud Storage</li>
<li>Sends an email giving the daily total</li>
</ol>
<p>Log into your RStudio Server instance and create the following script:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleCloudStorageR)
<span class="kw">library</span>(bigQueryR)
<span class="kw">library</span>(gmailr)
<span class="kw">library</span>(googleAnalyticsR)

## set options for authentication
<span class="kw">options</span>(<span class="dt">googleAuthR.client_id =</span> XXXXX)
<span class="kw">options</span>(<span class="dt">googleAuthR.client_secret =</span> XXXX)
<span class="kw">options</span>(<span class="dt">googleAuthR.scopes.selected =</span> <span class="kw">c</span>(<span class="st">"https://www.googleapis.com/auth/cloud-platform"</span>,
                                        <span class="st">"https://www.googleapis.com/auth/analytics.readonly"</span>))

## authenticate
## using service account, ensure service account email added to GA account, BigQuery user permissions set, etc.
googleAuthR::<span class="kw">gar_auth_service</span>(<span class="st">"auth.json"</span>)

## get Google Analytics data
gadata &lt;-<span class="st"> </span><span class="kw">google_analytics_4</span>(<span class="dv">123456</span>, 
                             <span class="dt">date_range =</span> <span class="kw">c</span>(<span class="kw">Sys.Date</span>() -<span class="st"> </span><span class="dv">2</span>, <span class="kw">Sys.Date</span>() -<span class="st"> </span><span class="dv">1</span>),
                             <span class="dt">metrics =</span> <span class="st">"sessions"</span>,
                             <span class="dt">dimensions =</span> <span class="st">"medium"</span>,
                             <span class="dt">anti_sample =</span> <span class="ot">TRUE</span>)

## upload to Google BigQuery
<span class="kw">bqr_upload_data</span>(<span class="dt">projectId =</span> <span class="st">"myprojectId"</span>, 
                <span class="dt">datasetId =</span> <span class="st">"mydataset"</span>,
                <span class="dt">tableId =</span> <span class="kw">paste0</span>(<span class="st">"gadata_"</span>,<span class="kw">format</span>(<span class="kw">Sys.Date</span>(),<span class="st">"%Y%m%d"</span>)),
                <span class="dt">upload_data =</span> gadata,
                <span class="dt">create =</span> <span class="ot">TRUE</span>)

## upload to Google Cloud Storage
<span class="kw">gcs_upload</span>(gadata, <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">"gadata_"</span>,<span class="kw">Sys.Date</span>(),<span class="st">".csv"</span>))


## get top medium referrer
top_ref &lt;-<span class="st"> </span><span class="kw">paste</span>(gadata[<span class="kw">order</span>(gadata$sessions, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>),][<span class="dv">1</span>, ], <span class="dt">collapse =</span> <span class="st">","</span>)
<span class="co"># 3456, organic</span>

## send email with todays figures
daily_email &lt;-<span class="st"> </span><span class="kw">mime</span>(
  <span class="dt">To =</span> <span class="st">"bob@myclient.com"</span>,
  <span class="dt">From =</span> <span class="st">"bill@cool-agency.com"</span>,
  <span class="dt">Subject =</span> <span class="st">"Todays winner is...."</span>,
  <span class="dt">body =</span> <span class="kw">paste0</span>(<span class="st">"Top referrer was: "</span>),top_ref)
<span class="kw">send_message</span>(daily_email)</code></pre></div>
<p>Save the script within RStudio as <code>daily-report.R</code></p>
<p>You can then use <a href="https://github.com/bnosac/cronR"><code>cronR</code></a> to schedule the script for a daily extract.</p>
<p>Use <code>cronR</code>’s RStudio addin, or in the console issue:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(cronR)
<span class="kw">cron_add</span>(<span class="kw">paste0</span>(<span class="st">"Rscript "</span>, <span class="kw">normalizePath</span>(<span class="st">"daily-report"</span>)), <span class="dt">frequency =</span> <span class="st">"daily"</span>)
<span class="co"># Adding cronjob:</span>
<span class="co"># ---------------</span>
<span class="co">#</span>
<span class="co"># ## cronR job</span>
<span class="co"># ## id:   fe9168c7543cc83c1c2489de82216c0f</span>
<span class="co"># ## tags: </span>
<span class="co"># ## desc: </span>
<span class="co"># 0 0 * * * Rscript /home/mark/demo-schedule.R</span></code></pre></div>
<p>The script will then run every day.</p>
<p>Test the script locally and with a test schedule before using in production. Once satisfied, you can run locally the <code><a href="../reference/gce_push_registry.html">gce_push_registry()</a></code> again to save the RStudio image with your scehduled script embedded within.</p>
<p>If you want to call the scheduled data from a Shiny app, you can now fetch the data again via <code>bqr_query</code> from <code>bigQueryR</code> or <code>gcs_get_object</code> from <code>googleCloudStorageR</code> within your <code>server.R</code> to pull in the data into your app at runtime.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#rstudio-server-scheduler">RStudio server + scheduler</a><ul class="nav nav-pills nav-stacked">
<li><a href="#tldr">TL;DR</a></li>
      <li><a href="#how-to-customise-your-own-rstudio-server">How to customise your own RStudio Server</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
