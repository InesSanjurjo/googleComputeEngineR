<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>R Interface with Google Compute Engine &bull; googleComputeEngineR</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet"><script src="jquery.sticky-kit.min.js"></script><script src="pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">googleComputeEngineR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">News</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header><div class="row">
  <div class="contents col-md-9">
    <div id="googlecomputeenginer" class="section level1">
<div class="page-header"><h1 class="hasAnchor"><a href="#googlecomputeenginer" class="anchor"> </a>googleComputeEngineR</h1></div>
<p>An R interface to the Google Cloud Compute Engine API, for launching virtual machines.</p>
<p><a href="http://cran.r-project.org/package=googleComputeEngineR"><img src="http://www.r-pkg.org/badges/version/googleComputeEngineR" alt="CRAN"></a> <a href="https://travis-ci.org/cloudyr/googleComputeEngineR"><img src="https://travis-ci.org/cloudyr/googleComputeEngineR.png?branch=master" alt="Build Status"></a> <a href="https://codecov.io/github/cloudyr/googleComputeEngineR?branch=master"><img src="https://img.shields.io/codecov/c/github/cloudyr/googleComputeEngineR/master.svg" alt="Coverage Status"></a></p>
<div id="tldr" class="section level2">
<h2 class="hasAnchor">
<a href="#tldr" class="anchor"> </a>TL;DR</h2>
<ol><li>Configure a Google Cloud Project with billing</li>
<li>Download a service acount key JSON file</li>
<li>Put your default project, zone and JSON file location in your <code>.Renviron</code>
</li>
<li>Run <code>library(googleComputeEngineR)</code> and auto-authenticate</li>
<li>Run <code>vm &lt;- gce_vm("rstudio", name = "rstudio-server", username = "mark", password = "mark1234")</code> (or other credentials) to start up an RStudio Server.</li>
<li>Wait for it to install, login via the returned URL.</li>
</ol></div>
<div id="thanks-to" class="section level2">
<h2 class="hasAnchor">
<a href="#thanks-to" class="anchor"> </a>Thanks to:</h2>
<ul><li>Scott Chamberlin for the <a href="https://github.com/sckott/analogsea">analogsea</a> package for launching Digital Ocean VMs, which inspired the SSH connector functions for this one.</li>
<li>Winston Chang for the <a href="https://github.com/wch/harbor/">harbor</a> package where the docker functions come from. If <code>harbor</code> will be published to CRAN, it will become a dependency for this one.</li>
<li>Henrik Bengtsson for help in integrating the fantastic <a href="https://cran.r-project.org/web/packages/future/index.html"><code>future</code></a> package that allows asynchronous R functions run in GCE clusters.</li>
<li>Carl Boettiger and Dirk Eddelbuettel for the <a href="https://hub.docker.com/u/rocker/"><code>rocker</code> project</a> that Docker containers some of the R templates used in this package.</li>
</ul></div>
<div id="install" class="section level2">
<h2 class="hasAnchor">
<a href="#install" class="anchor"> </a>Install</h2>
<p>Its not on CRAN yet:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">"MarkEdmondson1234/googleComputeEngineR"</span>)</code></pre></div>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"> </a>Setup</h2>
<p>Google Compute Engine lets you create and run virtual machines on Google infrastructure. See the <a href="https://cloud.google.com/compute/docs/">documentation here</a>.</p>
<p>Before you begin, you will need to set up a Cloud Platform project, and enable billing by adding a credit card.</p>
<p>A quickstart guide is <a href="https://cloud.google.com/compute/docs/quickstart-linux">available here</a> for making your first VM via the web interface, if you are not familiar with GCE then its best to start there.</p>
<p>Pricing is <a href="https://cloud.google.com/compute/pricing">available here</a>.</p>
<p>For <code>googleComputeEngineR</code> you will need:</p>
<ul><li>Your project ID e.g. <code>my-project-name</code>
</li>
<li>Your preferred geographical zone to launch VMs e.g. <code>europe-west1-a</code>
</li>
<li>[Optional] A <code>Service account key</code> json file, downloaded from the API Manager &gt; Credentials &gt; Create credentials &gt; Service account key &gt; Key type = JSON</li>
<li>[Optional] If not using service account key, you will need the <code>client-id</code> and <code>client-secret</code> for your project.</li>
</ul><blockquote>
<p>The recommended method to authenticate is using the JSON service account key via auto-authentication.</p>
</blockquote>
</div>
<div id="authentication" class="section level2">
<h2 class="hasAnchor">
<a href="#authentication" class="anchor"> </a>Authentication</h2>
<div id="oauth2" class="section level3">
<h3 class="hasAnchor">
<a href="#oauth2" class="anchor"> </a>OAuth2</h3>
<p>Authentication can be carried out via OAuth2 each session via <code><a href="reference/gce_auth.html">gce_auth()</a></code>. The first time you run this you will be sent to a Google login prompt in your browser to allow the <code>googleAuthR</code> project access (or preferably the Google project you configure via client ID).</p>
<p>Once authenticated a file named <code>.httr-oauth</code> is saved to your working directory. On subsequent authentication this file will hold your authentication details, and you won&rsquo;t need to go via the browser. Deleting this file, or setting <code>new_user=TRUE</code> will start the authentication flow again.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## set your project ID and secret if not using service account JSON
<span class="kw">options</span>(<span class="dt">googleAuthR.client_id =</span> YOUR_CLIENT_ID)
<span class="kw">options</span>(<span class="dt">googleAuthR.client_secret =</span> YOUR_CLIENT_SECRET)

<span class="kw">library</span>(googleComputeEngineR)
## first time this will send you to the browser to authenticate
<span class="kw"><a href="reference/gce_auth.html">gce_auth</a></span>()

## to authenticate with a fresh user, delete .httr-oauth or run with new_user=TRUE
<span class="kw"><a href="reference/gce_auth.html">gce_auth</a></span>(<span class="dt">new_user =</span> <span class="ot">TRUE</span>)

...call functions...etc...</code></pre></div>
<p>Each new R session will need to run <code><a href="reference/gce_auth.html">gce_auth()</a></code> to authenticate future API calls.</p>
</div>
<div id="auto-authentication" class="section level3">
<h3 class="hasAnchor">
<a href="#auto-authentication" class="anchor"> </a>Auto-authentication</h3>
<p>Alternatively, you can specify the location of a service account JSON file taken from your Google Project, or the location of a previously created <code>.httr-oauth</code> token in a system environment:</p>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">    <span class="kw">Sys.setenv</span>(<span class="st">"GCE_AUTH_FILE"</span> =<span class="st"> "/fullpath/to/auth.json"</span>)</code></pre></div>
<p>You can set default projects, zone and authentication via an <code>.Renviron</code> file or <code>Sys.setenv()</code>.</p>
<p>Example entries:</p>
<pre><code>GCE_AUTH_FILE="/Users/mark/xxxxx/auth.json"
GCE_DEFAULT_PROJECT="mark-xxxxxxx"
GCE_DEFAULT_ZONE="europe-west1-a"
GCE_SSH_USER="mark"</code></pre>
<p>This file will then used for authentication via <code><a href="reference/gce_auth.html">gce_auth()</a></code> when you load the library:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## GCE_AUTH_FILE set so auto-authentication
&gt;<span class="st"> </span><span class="kw">library</span>(googleComputeEngineR)
Successfully authenticated via /Users/mark/auth.json
Set default project name to <span class="st">'mark-xxxxx'</span>
Set default zone to <span class="st">'europe-west1-a'</span>

## no need for gce_auth()
&gt;<span class="st"> </span><span class="kw"><a href="reference/gce_get_project.html">gce_get_project</a></span>()
$kind
[<span class="dv">1</span>] <span class="st">"compute#project"</span>

$id
[<span class="dv">1</span>] <span class="st">"43534234234324324"</span>

$creationTimestamp
[<span class="dv">1</span>] <span class="st">"2015-05-08T15:22:38.416-07:00"</span>

$name
[<span class="dv">1</span>] <span class="st">"mark-xxxxx"</span>

...etc.... </code></pre></div>
</div>
</div>
<div id="launch-a-virtual-machine" class="section level2">
<h2 class="hasAnchor">
<a href="#launch-a-virtual-machine" class="anchor"> </a>Launch a Virtual Machine</h2>
<p>To launch a VM, use <code><a href="reference/gce_vm.html">gce_vm()</a></code>. This will:</p>
<ul><li>Return the instance metadata if it is already running</li>
<li>Start the instance and return its metadata if its currently stopped.</li>
<li>Create a VM if you include configurations detailed below.</li>
</ul><div id="start-an-existing-vm" class="section level3">
<h3 class="hasAnchor">
<a href="#start-an-existing-vm" class="anchor"> </a>Start an existing VM</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)

## auto auth, project and zone pre-set

## list your VMs in the project/zone
the_list &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_list_instances.html">gce_list_instances</a></span>()

## start an existing instance
job &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="st">"markdev"</span>)</code></pre></div>
</div>
<div id="reset-and-stop-vm" class="section level3">
<h3 class="hasAnchor">
<a href="#reset-and-stop-vm" class="anchor"> </a>Reset and Stop VM</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## reset instance
job &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm_reset.html">gce_vm_reset</a></span>(<span class="st">"markdev"</span>)
  
## check job until its finished
<span class="kw"><a href="reference/gce_wait.html">gce_check_zone_op</a></span>(job$name, <span class="dt">wait =</span> <span class="dv">20</span>)
  
## stop VM
job &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm_stop.html">gce_vm_stop</a></span>(<span class="st">"markdev"</span>)
  
## check job until finished
<span class="kw"><a href="reference/gce_wait.html">gce_check_zone_op</a></span>(job$name, <span class="dt">wait =</span> <span class="dv">20</span>)
  
inst &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_get_instance.html">gce_get_instance</a></span>(<span class="st">"markdev"</span>)
inst$status
[<span class="dv">1</span>] <span class="st">"TERMINATED"</span>  </code></pre></div>
</div>
<div id="external-ip" class="section level3">
<h3 class="hasAnchor">
<a href="#external-ip" class="anchor"> </a>External IP</h3>
<p>You can view the external IP for an instance via <code><a href="reference/gce_get_external_ip.html">gce_get_external_ip()</a></code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span>ip &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_get_external_ip.html">gce_get_external_ip</a></span>(<span class="st">"xxxxx"</span>)
 External IP for instance xxxxxx  :<span class="st">  </span><span class="fl">146.</span>1xx<span class="fl">.24</span>.xx </code></pre></div>
</div>
</div>
<div id="creating-an-instance" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-an-instance" class="anchor"> </a>Creating an instance</h2>
<p>To create an instance from scratch you need to specify:</p>
<ul><li>Name</li>
<li>Project [if not default]</li>
<li>Zone [if not default]</li>
<li>Machine type - either a predefined type or custom CPU and memory</li>
<li>Network - usually default, specifies open ports etc.</li>
<li>Image - a source disk image containing the operating system, that may come from another image project or a snapshot</li>
</ul><div id="default-settings" class="section level3">
<h3 class="hasAnchor">
<a href="#default-settings" class="anchor"> </a>Default settings</h3>
<p>The default settings let you create a VM like so:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## create a VM
&gt;<span class="st"> </span>vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="dt">name =</span> <span class="st">"test-vm"</span>)

## VM metadata
&gt;<span class="st"> </span>vm
==Google Compute Engine Instance==

Name:<span class="st">                </span>test-vm
Created:<span class="st">             </span><span class="dv">2016-11-11</span> <span class="dv">12</span>:<span class="dv">27</span>:<span class="dv">32</span>
Machine Type:<span class="st">        </span>f1-micro
Status:<span class="st">              </span>RUNNING
Zone:<span class="st">                </span>europe-west1-b
External IP:<span class="st">         </span><span class="fl">104.199.72.152</span>
Disks:<span class="st"> </span>
<span class="st">             </span>deviceName       type       mode boot autoDelete
<span class="dv">1</span> test-vm-boot-disk PERSISTENT READ_WRITE <span class="ot">TRUE</span>       <span class="ot">TRUE</span></code></pre></div>
<p>The defaults for a new VM are:</p>
<ul><li><code>predefined_type = "f1-micro"</code></li>
<li><code>image_project = "debian-cloud"</code></li>
<li><code>image_family = "debian-8"</code></li>
<li><code>network = "default"</code></li>
</ul></div>
</div>
<div id="templated-container-based-vms" class="section level2">
<h2 class="hasAnchor">
<a href="#templated-container-based-vms" class="anchor"> </a>Templated Container based VMs</h2>
<p>There is support for RStudio, Shiny and OpenCPU docker images using the above to launch configurations. The configurations are located in the <a href="https://github.com/MarkEdmondson1234/googleComputeEngineR/tree/master/inst/cloudconfig"><code>/inst/cloudconfig</code></a> package folder.</p>
<p>To launch those, use the <code><a href="reference/gce_vm.html">gce_vm()</a></code> function and specify the argument <code>template</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## for rstudio, you also need to specify a username and password to login
&gt;<span class="st"> </span>vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="dt">template =</span> <span class="st">"rstudio"</span>,
               <span class="dt">name =</span> <span class="st">"rstudio-server"</span>,
               <span class="dt">username =</span> <span class="st">"mark"</span>, <span class="dt">password =</span> <span class="st">"mark1234"</span>)

Checking job....
Job running:<span class="st">  </span><span class="dv">0</span> /<span class="dv">100</span>
Job running:<span class="st">  </span><span class="dv">0</span> /<span class="dv">100</span>
Operation complete in <span class="dv">22</span> secs
 External IP for instance rstudio  :<span class="st">  </span><span class="fl">130.211.62.2</span> 

##  rstudio running at 130.211.62.2:8787 

 You may need to wait a few minutes for the inital docker container to download and install before logging in.</code></pre></div>
<p>You can then use <code>gce_vm_stop</code>, <code>gce_vm_start</code> etc. for your server. You are only charged for when the VM is running, so you can stop it until you need it.</p>
<div id="container-based-vms" class="section level3">
<h3 class="hasAnchor">
<a href="#container-based-vms" class="anchor"> </a>Container based VMs</h3>
<p>There is also support for launching VMs from a docker container, as configured via a <a href="https://cloudinit.readthedocs.io/en/latest/topics/format.html">cloud-init</a> configuration file.</p>
<p>Here is the example from the <a href="https://cloud.google.com/compute/docs/containers/vm-image/">Google documentation</a> - save this file locally:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="co">#cloud-config</span>

<span class="fu">users:</span>
<span class="kw">-</span> <span class="fu">name:</span> cloudservice
  <span class="fu">uid:</span> 2000

<span class="fu">write_files:</span>
<span class="kw">-</span> <span class="fu">path:</span> /etc/systemd/system/cloudservice.service
  <span class="fu">permissions:</span> 0644
  <span class="fu">owner:</span> root
  <span class="fu">content:</span> |
    <span class="kw">[</span>Unit<span class="kw">]</span>
    Description=Start a simple docker container

    <span class="kw">[</span>Service<span class="kw">]</span>
    Environment=<span class="st">"HOME=/home/cloudservice"</span>
    ExecStartPre=/usr/share/google/dockercfg_update.sh
    <span class="fu">ExecStart=/usr/bin/docker run --rm -u 2000 --name=mycloudservice gcr.io/google-containers/busybox:</span>latest /bin/sleep 3600
    ExecStop=/usr/bin/docker stop mycloudservice
    ExecStopPost=/usr/bin/docker rm mycloudservice

<span class="fu">runcmd:</span>
<span class="kw">-</span> systemctl daemon-reload
<span class="kw">-</span> systemctl start cloudservice.service</code></pre></div>
<p>If the above is saved as <code>example.yaml</code> you can then launch a VM using its configuration via the <code><a href="reference/gce_vm_container.html">gce_vm_container()</a></code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="dt">cloud_init =</span> <span class="st">"example.yml"</span>,
              <span class="dt">name =</span> <span class="st">"test-container"</span>,
              <span class="dt">predefined_type =</span> <span class="st">"f1-micro"</span>)</code></pre></div>
</div>
<div id="custom-settings-for-vms" class="section level3">
<h3 class="hasAnchor">
<a href="#custom-settings-for-vms" class="anchor"> </a>Custom settings for VMs</h3>
<p>You can examine different options via the various list commands:</p>
<div id="machine-type" class="section level4">
<h4 class="hasAnchor">
<a href="#machine-type" class="anchor"> </a>Machine type</h4>
<p>A list of the predefined machine types:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="reference/gce_list_machinetype.html">gce_list_machinetype</a></span>()</code></pre></div>
</div>
<div id="images" class="section level4">
<h4 class="hasAnchor">
<a href="#images" class="anchor"> </a>Images</h4>
<p>A list of the image projects and families available is here: <code>https://cloud.google.com/compute/docs/images</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="reference/gce_list_images.html">gce_list_images</a></span>(<span class="dt">image_project =</span> <span class="st">"debian-cloud"</span>)</code></pre></div>
</div>
<div id="network" class="section level4">
<h4 class="hasAnchor">
<a href="#network" class="anchor"> </a>Network</h4>
<p>Most of the time you will want to leave network to the default, at present you can only configure this in the UI.</p>
</div>
<div id="disks" class="section level4">
<h4 class="hasAnchor">
<a href="#disks" class="anchor"> </a>Disks</h4>
<p>You can also create another disk to attach to the VM via:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="reference/gce_make_disk.html">gce_make_disk</a></span>(<span class="st">"my-disk"</span>)</code></pre></div>
<p>By default it will be a 500GB disk unless you specify otherwise. You can then attach this disk to the instance upon creation using the <code>disk_source</code> argument set to the disk resource URL.</p>
</div>
<div id="metadata" class="section level4">
<h4 class="hasAnchor">
<a href="#metadata" class="anchor"> </a>Metadata</h4>
<p>You can add custom metadata by passing a named list to the instance. More details from Google documentation is here <code>https://cloud.google.com/compute/docs/storing-retrieving-metadata</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm_create.html">gce_vm_create</a></span>(<span class="dt">name =</span> <span class="st">"test-vm2"</span>, 
                      <span class="dt">predefined_type =</span> <span class="st">"f1-micro"</span>,
                      <span class="dt">metadata =</span> <span class="kw">list</span>(<span class="dt">start_date =</span> <span class="kw">as.character</span>(<span class="kw">Sys.Date</span>())))</code></pre></div>
<p>This includes useful utilities such as <code>startup-script</code> and <code>shutdown-script</code> that you can use to run shell scripts. In those cases the named list should include the script as its value.</p>
</div>
</div>
</div>
<div id="logging-in-to-your-instance" class="section level2">
<h2 class="hasAnchor">
<a href="#logging-in-to-your-instance" class="anchor"> </a>Logging in to your instance</h2>
<p>Google Cloud comes with a browser based SSH application, which you can launch via <code>gce_ssh_browser</code> to set it up further to your liking.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)
<span class="kw"><a href="reference/gce_ssh_browser.html">gce_ssh_browser</a></span>(<span class="st">"my-server"</span>)</code></pre></div>
<p><img src="http://g.recordit.co/TpM4IfRLgf.gif"></p>
</div>
<div id="ssh-commands" class="section level2">
<h2 class="hasAnchor">
<a href="#ssh-commands" class="anchor"> </a>SSH commands</h2>
<p>You can also send ssh commands to your running instance from R via the <code><a href="reference/gce_ssh.html">gce_ssh()</a></code> commands.</p>
<p>For this you will need to either connect first via the <code>gcloud compute ssh</code> command that generates SSH-keys, or generate them yourself following this <a href="https://cloud.google.com/compute/docs/instances/connecting-to-instance">Google guide</a>.</p>
<p>Once you have generated for your username, the public and private key, you can connect via:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)

vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="st">"my-instance"</span>)

## add SSH info to the VM object
vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_ssh_addkeys.html">gce_ssh_addkeys</a></span>(<span class="dt">username =</span> <span class="st">"mark"</span>, 
                      <span class="dt">instance =</span> <span class="st">"your-instance"</span>, 
                      <span class="dt">key.pub =</span> <span class="st">"filepath.to.public.key"</span>,
                      <span class="dt">key.private =</span> <span class="st">"filepath.to.private.key"</span>)
  
## run command on instance            
<span class="kw"><a href="reference/gce_ssh.html">gce_ssh</a></span>(vm, <span class="st">"echo foo"</span>)
<span class="co"># foo</span></code></pre></div>
<p>You can also call <code>gce_ssh</code> directly which will call <code>gce_ssh_addkeys</code> if it has not been run already. It will look for a username via <code>Sys.info()[["user"]]</code> or you will need to specify it in the first call you make.</p>
</div>
<div id="docker-commands" class="section level2">
<h2 class="hasAnchor">
<a href="#docker-commands" class="anchor"> </a>Docker commands</h2>
<p>For docker containers, you can use the package <a href="https://github.com/wch/harbor"><code>harbor</code></a> to speak to the docker containers on the instance. You can also develop your docker container locally first using BootToDocker or similar before pushing it up.</p>
<p>For now, install this fork of harbor:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">"MarkEdmondson1234/harbor"</span>)
<span class="kw">library</span>(harbor)</code></pre></div>
<p>Then a demo using it to speak to a docker container is below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)
<span class="kw">library</span>(harbor)

<span class="co"># Create a virtual machine on Google Compute Engine</span>
ghost &lt;-<span class="st">   </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="st">"demo"</span>, 
                  <span class="dt">image_project =</span> <span class="st">"google-containers"</span>,
                  <span class="dt">image_family =</span> <span class="st">"gci-stable"</span>,
                  <span class="dt">predefined_type =</span> <span class="st">"f1-micro"</span>)

ghost
<span class="co">#&gt; ==Google Compute Engine Instance==</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Name:                demo</span>
<span class="co">#&gt; Created:             2016-10-06 04:41:56</span>
<span class="co">#&gt; Machine Type:        f1-micro</span>
<span class="co">#&gt; Status:              RUNNING</span>
<span class="co">#&gt; Zone:                europe-west1-b</span>
<span class="co">#&gt; External IP:         104.155.0.147</span>
<span class="co">#&gt; Disks: </span>
<span class="co">#&gt;       deviceName       type       mode boot autoDelete</span>
<span class="co">#&gt; 1 demo-boot-disk PERSISTENT READ_WRITE TRUE       TRUE</span>


<span class="co"># Create and run a container in the virtual machine.</span>
<span class="co"># 'user' is the one you used to create the SSH keys</span>

<span class="co"># This might take a while.</span>
con &lt;-<span class="st"> </span><span class="kw">docker_run</span>(ghost, <span class="st">"debian"</span>, <span class="st">"echo foo"</span>, <span class="dt">user =</span> <span class="st">"mark"</span>)
<span class="co">#&gt; Warning: Permanently added '104.155.0.147' (RSA) to the list of known hosts.</span>
<span class="co">#&gt; Unable to find image 'debian:latest' locally</span>
<span class="co">#&gt; latest: Pulling from library/debian</span>
<span class="co">#&gt; 6a5a5368e0c2: Pulling fs layer</span>
<span class="co">#&gt; 6a5a5368e0c2: Verifying Checksum</span>
<span class="co">#&gt; 6a5a5368e0c2: Download complete</span>
<span class="co">#&gt; 6a5a5368e0c2: Pull complete</span>
<span class="co">#&gt; Digest: sha256:677f184a5969847c0ad91d30cf1f0b925cd321e6c66e3ed5fbf9858f58425d1a</span>
<span class="co">#&gt; Status: Downloaded newer image for debian:latest</span>
<span class="co">#&gt; foo</span>

con
<span class="co">#&gt; &lt;container&gt;</span>
<span class="co">#&gt;   ID:       92f96d32d081 </span>
<span class="co">#&gt;   Name:     harbor_6rdevp </span>
<span class="co">#&gt;   Image:    debian </span>
<span class="co">#&gt;   Command:  echo foo </span>
<span class="co">#&gt;   Host:     ==Google Compute Engine Instance==</span>
<span class="co">#&gt;   </span>
<span class="co">#&gt;   Name:                demo</span>
<span class="co">#&gt;   Created:             2016-10-06 04:41:56</span>
<span class="co">#&gt;   Machine Type:        f1-micro</span>
<span class="co">#&gt;   Status:              RUNNING</span>
<span class="co">#&gt;   Zone:                europe-west1-b</span>
<span class="co">#&gt;  External IP:         104.155.0.147</span>
<span class="co">#&gt;   Disks: </span>
<span class="co">#&gt;         deviceName       type       mode boot autoDelete</span>
<span class="co">#&gt;   1 demo-boot-disk PERSISTENT READ_WRITE TRUE       TRUE</span>
  
  
<span class="co"># Destroy the virtual machine from Google Compute Engine</span>
<span class="kw"><a href="reference/gce_vm_delete.html">gce_vm_delete</a></span>(ghost)</code></pre></div>
<p>To run R commands within a docker image in the cloud:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)
<span class="kw">library</span>(harbor)

## make instance using R-base
vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="dt">template =</span> <span class="st">"r-base"</span>, <span class="dt">name =</span> <span class="st">"rbase"</span>)

## add SSH info to the VM object
vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_ssh_addkeys.html">gce_ssh_addkeys</a></span>(<span class="dt">username =</span> <span class="st">"mark"</span>, 
                      <span class="dt">instance =</span> <span class="st">"your-instance"</span>, 
                      <span class="dt">key.pub =</span> <span class="st">"filepath.to.public.key"</span>,
                      <span class="dt">key.private =</span> <span class="st">"filepath.to.private.key"</span>)

## run an R function on the instance within the R-base docker image
<span class="kw">docker_run</span>(vm, <span class="st">"rocker/r-base"</span>, <span class="kw">c</span>(<span class="st">"Rscript"</span>, <span class="st">"-e"</span>, <span class="st">"1+1"</span>), <span class="dt">user =</span> <span class="st">"mark"</span>)
<span class="co">#&gt; [1] 2</span>

<span class="kw"><a href="reference/gce_vm_delete.html">gce_vm_delete</a></span>(vm)
<span class="co">#&gt; ==Operation delete :  PENDING</span>
<span class="co">#&gt; Started:  2016-10-07 02:37:14</span>

<span class="kw"><a href="reference/gce_wait.html">gce_check_zone_op</a></span>(.Last.value)
<span class="co">#&gt; Operation complete in 33 secs </span>
<span class="co">#&gt; ==Operation delete :  DONE</span>
<span class="co">#&gt; Started:  2016-10-07 02:37:14</span>
<span class="co">#&gt; Ended: 2016-10-07 02:37:47 </span>
<span class="co">#&gt; Operation complete in 33 secs </span></code></pre></div>
<p>Using <code>harbor</code> you can see other metadata about your container from your local R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)
<span class="kw">library</span>(harbor)

vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm_template.html">gce_vm_template</a></span>(<span class="st">"rstudio"</span>, 
                      <span class="dt">username =</span> <span class="st">"mark"</span>, 
                      <span class="dt">password =</span> <span class="st">"mark1234"</span>, 
                      <span class="dt">predefined_type =</span> <span class="st">"f1-micro"</span>)
                                         
## get running rstudio container
cont &lt;-<span class="st"> </span><span class="kw">containers</span>(vm)
<span class="kw">names</span>(cont)
<span class="st">"rstudio"</span>

## see if its running
<span class="kw">container_running</span>(con$rstudio)
[<span class="dv">1</span>] <span class="ot">TRUE</span>

## get logs from container
<span class="kw">container_logs</span>(con$rstudio)

## get metadata
<span class="kw">container_update_info</span>(con$rstudio)
&lt;container&gt;
<span class="st">  </span>ID:<span class="st">       </span>05c5437ac968 
  Name:<span class="st">     </span>rstudio 
  Image:<span class="st">    </span>rocker/rstudio 
  Command:<span class="st">  </span><span class="er">/</span>init 
  Host:<span class="st">     </span><span class="er">==</span>Google Compute Engine Instance==
<span class="st">  </span>
<span class="st">  </span>Name:<span class="st">                </span>rstudio-dev
  Created:<span class="st">             </span><span class="dv">2016-10-07</span> <span class="dv">03</span>:<span class="dv">30</span>:<span class="dv">24</span>
  Machine Type:<span class="st">        </span>f1-micro
  Status:<span class="st">              </span>RUNNING
  Zone:<span class="st">                </span>europe-west1-b
  External IP:<span class="st">         </span><span class="fl">104.199.19.222</span>
  Disks:<span class="st"> </span>
<span class="st">               </span>deviceName       type       mode boot autoDelete
  <span class="dv">1</span> rstudio-dev-boot-disk PERSISTENT READ_WRITE <span class="ot">TRUE</span>       <span class="ot">TRUE</span></code></pre></div>
</div>
<div id="using-private-google-containers" class="section level2">
<h2 class="hasAnchor">
<a href="#using-private-google-containers" class="anchor"> </a>Using private Google Containers</h2>
<p>Google Cloud comes with a <a href="https://cloud.google.com/container-registry/">private container registry</a> that is available to all VMs created in the that project, where you can store docker containers.</p>
<p>You can use this to save the state of the container VMs so you can redeploy them to other instances quickly, without needing to set them up again with packages or code.</p>
<p>For this you need SSH access set up via <code>gce_ssh_addkeys</code> and the <code>harbor</code> package to manipulate the docker images:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)
<span class="kw">library</span>(harbor)

vm &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="dt">template =</span> <span class="st">"rstudio"</span>, 
             <span class="dt">name =</span> <span class="st">"rstudio-dev"</span>, 
             <span class="dt">username =</span> <span class="st">"mark"</span>,  <span class="dt">password =</span> <span class="st">"mark1234"</span>)

&gt;<span class="co"># External IP:         104.199.19.222</span></code></pre></div>
<p>Make your changes to the instance by logging in to the RStudio server at the IP provided, then this command will save it to the local registry under the name you specify.</p>
<p>This can take some time (5mins +) if its a new container. You should be able to see the image in the web UI when it is done at <code>https://console.cloud.google.com/kubernetes/images/list</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="reference/gce_save_container.html">gce_save_container</a></span>(vm, <span class="st">"my-rstudio"</span>)</code></pre></div>
<p>The container <code>my-rstudio</code> with your changes is now saved, and can be used to launch new containers.</p>
<p>To load onto another VM, use a Google container optimised instance with <code>image_project = "google-containers"</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vm2 &lt;-<span class="st">  </span><span class="kw"><a href="reference/gce_vm_create.html">gce_vm_create</a></span>(<span class="dt">name =</span> <span class="st">"new_instance"</span>,
                      <span class="dt">predefined_type =</span> <span class="st">"f1-micro"</span>,
                      <span class="dt">image_family =</span> <span class="st">"gci-stable"</span>,
                      <span class="dt">image_project =</span> <span class="st">"google-containers"</span>)

## load and run the container from previous setup
<span class="kw"><a href="reference/gce_load_container.html">gce_load_container</a></span>(vm2, <span class="st">"my-rstudio"</span>)</code></pre></div>
</div>
<div id="futures" class="section level2">
<h2 class="hasAnchor">
<a href="#futures" class="anchor"> </a>Futures</h2>
<p>You can run R functions asynchronously over a cluster of Google VMs using the R package <a href="https://cran.r-project.org/web/packages/future/index.html"><code>future</code></a>.</p>
<p>Consult the <a href="https://github.com/HenrikBengtsson/future">future readme</a> for further details, but a quick demo is shown below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(future)
<span class="kw">library</span>(googleComputeEngineR)

vm1 &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="st">"cluster1"</span>, <span class="dt">template =</span> <span class="st">"r-base"</span>)
vm2 &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="st">"cluster2"</span>, <span class="dt">template =</span> <span class="st">"r-base"</span>)
vm3 &lt;-<span class="st"> </span><span class="kw"><a href="reference/gce_vm.html">gce_vm</a></span>(<span class="st">"cluster2"</span>, <span class="dt">template =</span> <span class="st">"r-base"</span>)

vms &lt;-<span class="st"> </span><span class="kw">list</span>(vm1, vm2, vm3)
cl &lt;-<span class="st"> </span><span class="kw">lapply</span>(vms, <span class="dt">FUN =</span> as.cluster)
<span class="kw">plan</span>(cluster, <span class="dt">workers =</span> cl)

## use futures %&lt;-% to send a function to the cluster
si %&lt;-%<span class="st"> </span><span class="kw">Sys.info</span>()
<span class="kw">print</span>(si)

## tidy up
<span class="kw">lapply</span>(vms, <span class="dt">FUN =</span> gce_vm_stop)</code></pre></div>
<p>The package includes the function <code>gce_future_install_packages</code> which will load libraries onto your cluster and commit the r-base docker container they are running on.</p>
<p>You can then save these containers to the Google Container registry as detailed via <code>gce_save_container</code>, for loading and use later for your asynchronous projects.</p>
</div>
</div>
  </div>

  <div class="col-md-3" id="sidebar">
    <h2>Links</h2><ul class="list-unstyled"><li>Report a bug at <br><a href="https://github.com/cloudyr/googleComputeEngineR/issues">https://&#8203;github.com/&#8203;cloudyr/&#8203;googleComputeEngineR/&#8203;issues</a></li>
</ul><h2>License</h2>
<p><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE">LICENSE</a></p>
<h2>Developers</h2><ul class="list-unstyled"><li>Mark Edmondson <br><small class="roles"> Author, maintainer </small> </li>
<li><a href="authors.html">All authors...</a></li>
</ul></div>
</div>


      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer></div>

  </body></html>
